# Введение

API mserver использует подход [REST](http://wikipedia.org/wiki/REST). Клиенты API получают доступ к Кошельку, Сервисам, Платежам и Картам выполняя `GET`, `POST` и `DELETE` запросы к соответствующим ресурсам `/wallet`, `/services`, `/payments` и `/cards`. 
Вызовы API всегда возвращают JSON. Для возврата статуса запроса к API используется код состояния HTTP. 

## Аутентификация

Используется [BASIC аутентификация](http://wikipedia.org/wiki/Basic_access_authentication). В качестве логина используется номер телефона Кошелька в международном формате. Клиент может выполнять аутентификацию 1 раз за сессию, передавая в последующих запросах токен в куке `JSESSONID`. 

Возможны следующие коды ошибок, уточняющие HTTP статус 401:

| Код ошибки         | Описание    |
|------------------- |:------------|
|`wallet_not_active` | Кошелек не активирован. Активируйте кошелек вызовом POST /wallet/activate. |
|`wallet_disabled`   | Кошелек заблокирован администрацией. Причина блокировки возвращается в поле `details`. |
|`reset_password`    | Требуется смена пароля. Измените пароль вызовами POST /wallet/send_password_reset_code и POST /wallet/reset_password. |


## Ошибки

API использует HTTP статусы для возврата ошибок.

| Статус                | Описание                                                                                      |
| --------------------: |:----------------------------------------------------------------------------------------------|
| 200                   |  запрос выполнен успешно                                                                      |
| 400                   |  плохо сформированный запрос (например невалидный JSON)                                       |
| 401                   |  неверные учетные данные                                                                      |
| 404                   |  запрошенный ресурс не существует (для запрашивающего)                                        |
| 405                   |  не тот HTTP метод, например GET вместо POST                                                  |
| 415                   |  не тот content-type, мы поддерживаем только application/json                                 |
| 422                   |  запрос сформирован нормально, но не прошел валидацию, например поле не в нужном формате      |
| 5XX                   |  проблема с mserver, повторите запрос позже                                                   |

HTTP статус дублируется в поле `meta.status` ответа mserver. В определенных случаях вместе со статусом возвращается уточненный код ошибки в поле `meta.error`. 

> Например для неверного формата номера телефона при создании кошелка возвращается

```json
{
  "meta" : {
    "code" : 422,
    "error" : "invalid_phone"
  }
}
```

## Коды ошибок

| Код ошибки                 | Описание                                                                                |
| :---------------------     |:----------------------------------------------------------------------------------------|
|  wallet_not_found          | кошелек не существует                                                                   |
|  wallet_not_active         | кошелек не активирован                                                                  |
|  missing_phone             | не передан обязательный параметр: номер телефона                                        |
|  missing_password          | не передан обязательный параметр: пароль                                                |
|  invalid_password          | пароль должен быть не короче 6 символов                                                 |
|  invalid_phone             | требуется номер телефона в международном формате                                        |
|  phone_already_exists      | пользователь с таким номером телефона уже зарегистрирован                               |
|  already_disabled          | пользователь уже заблокирован                                                           |
|  already_enabled           | пользователь уже разлокирован                                                           |
|  already_active            | пользователь уже активирован                                                            |
|  code_expired              | код безопасности устарел                                                                |
|  invalid_code              | код безопасности не совпадает с отправленным в смс                                      |
|  failure_limit_exceeded    | превышен лимит попыток ввода кода безопасности                                          |
|  resend_limit_exceeded     | превышен лимит запросов кода безопасности                                               |
|  person_already_verified   | персональные данные уже идентифицированы                                                |
|  missing_type              | не передан обязательный параметр: тип платежа                                           |
|  missing_amount            | не передан обязательный параметр: сумма платежа                                         |
|  missing_parameters        | не передан обязательный параметр: параметры платежа                                     |
|  missing_destination       | не передан обязательный параметр: кошелек назначения перевода                           |
|  missing_service           | не передан обязательный параметр: сервис назначения платежа                             |
|  message_too_long          | сообщение адресату перевода не должно быть длиннее 1024 символа                         |
|  invalid_next_action       | неверное действие для многошагового платежа (например pay вместо update)                |
|  invalid_payment_status    | недопустимый статус платежа для действия pay                                            |
|  invalid_amount            | недопустимая сумма платежа                                                              |
|  card_not_found            | карта не существует                                                                     |
|  service_not_found         | сервис не существует                                                                    |
|  destination_not_found     | адресат перевода не существует                                                          |
|  invalid_destination       | нельзя отправить перевод самому себе                                                    |
|  card_not_active           | нельзя платить неактивной картой                                                        |
|  wallet_not_identified               | для совершения этого действия требуется идентификация пользователя кошелька   |
|  in_amount_limit_exceeded            | превышен лимит на сумму пополнения                                            |
|  out_amount_limit_exceeded           | превышен лимит на сумму платежа                                               |
|  amount_limit_exceeded               | превышен лимит на остаток на счете кошелька                                   |
|  monthly_in_turnover_limit_exceeded  | превышен лимит на месячный оборот пополнений                                  |
|  monthly_out_turnover_limit_exceeded | превышен лимит на месячный оборот платежей                                    |
|  active_cards_limit_exceeded         | превышен лимит на количество одновременно привязанных карт                    |

 

## Коды безопасности и контрольный разряд

Для активации созданного кошелька и для смены пароля используется 6-значный цифровой код безопасности, который генерируется случайным образом и отправляется СМС сообщением на телефон кошелька.
Запросы на создание кошелька, на повторную отправку кода активации и на отправку кода для смены пароля возвращают в поле `check_digit` контрольный разряд для сгенерированного кода безопасности, рассчитанный по [алгоритму Верхуффа](http://en.wikipedia.org/wiki/Verhoeff_algorithm). Клиентские приложения могут использовать контрольный разряд для обнаружения опечаток при вводе кода безопасности.

## Постраничный вывод списков

В ответах на запросы, возвращающие список элементов, сервер отдает полное количество элементов в поле `meta.page.total_elements`.

## Срочные данные

Часто изменяющиеся данные, в самых последних значениях которых заинтересован клиент, возвращаются в каждом ответе сервера в поле `meta.urgent_data`. Например, для API кошельков, возвращается доступный остаток на счете кошелька:

```json
{
  "meta" : {    
    "urgent_data" : {
      "amount" : 10010
    }
}
```