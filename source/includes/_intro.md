# Введение

API mserver использует подход [REST](http://wikipedia.org/wiki/REST). Клиенты API получают доступ к Кошельку, Сервисам, Платежам и Картам выполняя `GET`, `POST` и `DELETE` запросы к соответствующим ресурсам `/wallet`, `/services`, `/payments` и `/cards`. 
Вызовы API всегда возвращают JSON. Для возврата статуса запроса к API используется код состояния HTTP. 

## Аутентификация

Используется [BASIC аутентификация](http://wikipedia.org/wiki/Basic_access_authentication). В качестве логина используется номер телефона Кошелька в международном формате. Клиент может выполнять аутентификацию 1 раз за сессию, передавая в последующих запросах токен в куке `JSESSONID`. 

Возможны следующие коды ошибок, уточняющие HTTP статус 401:

| Код ошибки         | Описание    |
|------------------- |:------------|
|`wallet_not_active` | Кошелек не активирован. Активируйте кошелек вызовом POST /wallet/activate. |
|`wallet_disabled`   | Кошелек заблокирован администрацией. Причина блокировки возвращается в поле `details`. |
|`reset_password`    | Требуется смена пароля. Измените пароль вызовами POST /wallet/send_password_reset_code и POST /wallet/reset_password. |

> Для авторизации можно использовать такой шаблон:

```shell
$ curl -u<phone>:<password> <url>
```

## Ошибки

API использует HTTP статусы для возврата ошибок.

| Статус                | Описание                                                                                      |
| --------------------: |:----------------------------------------------------------------------------------------------|
| 200                   |  запрос выполнен успешно                                                                      |
| 400                   |  плохо сформированный запрос (например невалидный JSON)                                       |
| 401                   |  неверные учетные данные                                                                      |
| 404                   |  запрошенный ресурс не существует (для запрашивающего)                                        |
| 405                   |  не тот HTTP метод, например GET вместо POST                                                  |
| 415                   |  не тот content-type, мы поддерживаем только application/json                                 |
| 422                   |  запрос сформирован нормально, но не прошел валидацию, например поле не в нужном формате      |
| 5XX                   |  проблема с mserver, повторите запрос позже                                                   |

HTTP статус дублируется в поле `meta.status` ответа mserver. В определенных случаях вместе со статусом возвращается уточненный код ошибки в поле `meta.error`. 

> Например для неверного формата номера телефона при создании кошелка возвращается

```json
{
  "meta" : {
    "code" : 422,
    "error" : "invalid_phone"
  }
}
```

## Коды безопасности и контрольный разряд

Для активации созданного кошелька и для смены пароля используется 6-значный цифровой код безопасности, который генерируется случайным образом и отправляется СМС сообщением на телефон кошелька.
Запросы на создание кошелька, на повторную отправку кода активации и на отправку кода для смены пароля возвращают в поле `check_digit` контрольный разряд для сгенерированного кода безопасности, рассчитанный по [алгоритму Верхуффа](http://en.wikipedia.org/wiki/Verhoeff_algorithm). Клиентские приложения могут использовать контрольный разряд для обнаружения опечаток при вводе кода безопасности.
